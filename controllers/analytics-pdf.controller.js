
const path = require('path');
const fs = require('fs');
const generateAnalyticsPDF = require('../scripts/generateAnalyticsPDF');

exports.downloadAnalyticsReport = async (req, res) => {
  try {
    const { start, end } = req.query;

    // Dummy HTML (replace with real fetched analytics data)
    const html = `
      <html>
        <head>
          <style>
            body { font-family: Arial, sans-serif; padding: 20px; }
            h1 { color: #2a2a2a; }
            table { width: 100%; margin-top: 20px; border-collapse: collapse; }
            th, td { border: 1px solid #ddd; padding: 8px; }
            th { background-color: #f4f4f4; }
          </style>
        </head>
        <body>
          <h1>CYBEV Admin Report</h1>
          <p><strong>From:</strong> ${start} &nbsp;&nbsp;&nbsp; <strong>To:</strong> ${end}</p>
          <table>
            <tr><th>Metric</th><th>Value</th></tr>
            <tr><td>New Users</td><td>125</td></tr>
            <tr><td>Posts</td><td>320</td></tr>
            <tr><td>Views</td><td>8,452</td></tr>
            <tr><td>Earnings</td><td>$2,420</td></tr>
          </table>
          <p style="margin-top: 40px;">Generated by CYBEV AI Dashboard</p>
        </body>
      </html>
    `;

    const outputPath = path.join(__dirname, '../public/reports/admin-report.pdf');
    await generateAnalyticsPDF(html, outputPath);

    res.setHeader('Content-Type', 'application/pdf');
    res.setHeader('Content-Disposition', 'attachment; filename="admin-report.pdf"');
    fs.createReadStream(outputPath).pipe(res);
  } catch (error) {
    console.error("PDF Generation Failed:", error);
    res.status(500).json({ error: 'Failed to generate report' });
  }
};
